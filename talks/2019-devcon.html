<!DOCTYPE html>
<!-- saved from url=(0037)http://localhost:3999/metrics.slide#1 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Monitoring Ethereum infra</title>

    <script async="" src="./2019-devcon/analytics.js"></script><script src="./2019-devcon/slides.js"></script>
  <meta name="viewport" content="width=1100,height=750"><meta name="apple-mobile-web-app-capable" content="yes"><style>@media print {#ghostery-purple-box {display:none !important}}</style></head>

  <body style="display: none" class="loaded">

    <section class="slides layout-widescreen">

      <article class="current">
        <h1 style="font-size: 48px;">Monitoring Ethereum infra</h1>
        <h3 style="font-size: 36px; line-height: 36px;">A.k.a. "How do I debug Geth?!"</h3><br>
        <h3>10 October 2019</h3><h3>Devcon 5, Osaka</h3><br><br>
        <div class="presenter" style="position: absolute; bottom: 3em; left: 2em">



  <p>
    PÃ©ter SzilÃ¡gyi
  </p>





  <p>
    Go Ethereum Lead
  </p>



        </div>
        <img src="./2019-devcon/logo.svg" height="128px" style="position: absolute; bottom: 2em; right: 2em;">
      </article>



      <article class="next">

        <h3>Logging â€“ Glorified `printf`</h3>
        <img src="./2019-devcon/logging.jpg" style="position: absolute; right: 1em; top: 1em; height: 85px;">

<span style="position: absolute; left: 11.5em; bottom: 1.5em; font-size: 20px;">...either too silent...</span>
<span style="position: absolute; left: 35em; bottom: 1.5em; font-size: 20px;">...or too verbose...</span>

<div class="video">
  <video height="512" controls="">
    <source src="./2019-devcon/logging.mp4" type="video/mp4">
  </video>
</div>


      </article>



      <article class="far-next">

        <h3>Operationality is a spectrum</h3>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>
<div style="position: relative;"><div dir="ltr" style="position: relative; width: 978px; height: 50px;"><div aria-label="A chart." style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%;"><svg width="978" height="50" aria-label="A chart." style="overflow: hidden;"><defs id="_SPECTRUM_ID_0"><lineargradient id="_SPECTRUM_ID_1" x1="0%" y1="0" x2="100%" y2="0" gradientUnits="objectBoundingBox"><stop offset="0%" style="stop-color:#B2DF8A;stop-opacity:1"></stop><stop offset="100%" style="stop-color:#FFFF99;stop-opacity:1"></stop></lineargradient><lineargradient id="_SPECTRUM_ID_2" x1="0%" y1="0" x2="100%" y2="0" gradientUnits="objectBoundingBox"><stop offset="0%" style="stop-color:#FFFF99;stop-opacity:1"></stop><stop offset="100%" style="stop-color:#FDBF6F;stop-opacity:1"></stop></lineargradient><lineargradient id="_SPECTRUM_ID_3" x1="0%" y1="0" x2="100%" y2="0" gradientUnits="objectBoundingBox"><stop offset="0%" style="stop-color:#FDBF6F;stop-opacity:1"></stop><stop offset="100%" style="stop-color:#FB9A99;stop-opacity:1"></stop></lineargradient><lineargradient id="_SPECTRUM_ID_4" x1="0%" y1="0" x2="100%" y2="0" gradientUnits="objectBoundingBox"><stop offset="0%" style="stop-color:#FB9A99;stop-opacity:1"></stop><stop offset="100%" style="stop-color:#000000;stop-opacity:1"></stop></lineargradient><lineargradient id="_SPECTRUM_ID_5" x1="0%" y1="0" x2="100%" y2="0" gradientUnits="objectBoundingBox"><stop offset="0%" style="stop-color:#000000;stop-opacity:1"></stop><stop offset="100%" style="stop-color:#000000;stop-opacity:1"></stop></lineargradient></defs><g><path d="M10,0C71.19999999999999,0,132.39999999999998,0,193.6,0L193.6,42C132.39999999999998,42,71.19999999999999,42,10,42Z" stroke="none" stroke-width="0" fill-opacity="0.6" fill="url(#_SPECTRUM_ID_1)"></path><path d="M203.6,0C264.8,0,326,0,387.2,0L387.2,42C326,42,264.8,42,203.6,42Z" stroke="none" stroke-width="0" fill-opacity="0.6" fill="url(#_SPECTRUM_ID_2)"></path><path d="M397.2,0C458.4,0,519.5999999999999,0,580.8,0L580.8,42C519.5999999999999,42,458.4,42,397.2,42Z" stroke="none" stroke-width="0" fill-opacity="0.6" fill="url(#_SPECTRUM_ID_3)"></path><path d="M590.8,0C652,0,713.1999999999999,0,774.4,0L774.4,42C713.1999999999999,42,652,42,590.8,42Z" stroke="none" stroke-width="0" fill-opacity="0.6" fill="url(#_SPECTRUM_ID_4)"></path><path d="M784.4,0C845.6,0,906.8,0,968,0L968,42C906.8,42,845.6,42,784.4,42Z" stroke="none" stroke-width="0" fill-opacity="0.6" fill="url(#_SPECTRUM_ID_5)"></path></g><g><text text-anchor="start" x="16" y="26.6" font-family="sans-serif" font-size="16" stroke="none" stroke-width="0" fill="#000000">Perfect</text><text text-anchor="start" x="209.6" y="26.6" font-family="sans-serif" font-size="16" stroke="none" stroke-width="0" fill="#000000">Works</text><text text-anchor="start" x="403.2" y="26.6" font-family="sans-serif" font-size="16" stroke="none" stroke-width="0" fill="#000000">Kind of</text><text text-anchor="end" x="574.8" y="26.6" font-family="sans-serif" font-size="16" stroke="none" stroke-width="0" fill="#000000">Barely</text><text text-anchor="end" x="768.4" y="26.6" font-family="sans-serif" font-size="16" stroke="none" stroke-width="0" fill="#000000">Fails</text><text text-anchor="end" x="962" y="26.6" font-family="sans-serif" font-size="16" stroke="none" stroke-width="0" fill="#000000">Crashes</text><rect x="0" y="0" width="10" height="42" stroke="none" stroke-width="0" fill-opacity="0.8" fill="#b2df8a"></rect><rect x="193.6" y="0" width="10" height="42" stroke="none" stroke-width="0" fill-opacity="0.8" fill="#ffff99"></rect><rect x="387.2" y="0" width="10" height="42" stroke="none" stroke-width="0" fill-opacity="0.8" fill="#fdbf6f"></rect><rect x="580.8" y="0" width="10" height="42" stroke="none" stroke-width="0" fill-opacity="0.8" fill="#fb9a99"></rect><rect x="774.4" y="0" width="10" height="42" stroke="none" stroke-width="0" fill-opacity="0.8" fill="#000000"></rect><rect x="968" y="0" width="10" height="42" stroke="none" stroke-width="0" fill-opacity="0.8" fill="#000000"></rect></g><g></g><g></g><g></g><g></g><g></g></svg><div aria-label="A tabular representation of the data in the chart." style="position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden;"><table><thead><tr><th>From</th><th>To</th><th>Weight</th></tr></thead><tbody><tr><td>Perfect</td><td>Works</td><td>1</td></tr><tr><td>Works</td><td>Kind of</td><td>1</td></tr><tr><td>Kind of</td><td>Barely</td><td>1</td></tr><tr><td>Barely</td><td>Fails</td><td>1</td></tr><tr><td>Fails</td><td>Crashes</td><td>1</td></tr></tbody></table></div></div></div><div aria-hidden="true" style="display: none; position: absolute; top: 60px; left: 988px; white-space: nowrap; font-family: Arial; font-size: 16px;">1</div><div></div></div>


  <p>
    Software is never perfect... and rarely doesn't work...
  </p>


  <ul>

    <li>Bug-fixes improve operation, regressions worsen it</li>

    <li>Powerful machines push to the left, weaker to the right</li>

    <li>Network connectivity and work loads influence everything</li>

  </ul>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Operating an infrastructure is a game of trade-offs
  </p>


  <ul>

    <li>Too generous, it's wasteful; too stringent, it's unstable</li>

    <li>Question is, <i>how do you know how close your node is to failure?</i></li>

  </ul>


      </article>



      <article class="">

        <h3>Monitoring and metrics</h3>
        <img src="./2019-devcon/ethstats.png" style="position: absolute; right: 2em; top: 4.5em; width: 450px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 8.5em; bottom: 18em; font-size: 16px;">Not a new concept, just a new dimension</span>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Abstract goals of monitoring ðŸ˜•
  </p>


  <ul>

    <li>Measure anything deemed useful</li>

    <li>Aggregate, query and visualize the metrics</li>

  </ul>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Practically, you need to have questions
  </p>


  <ul>

    <li>Anomalies â€“ What is a specific node doing?</li>

    <li>Benchmarks â€“ How does version X &amp; Y compare?</li>

    <li>Health checks â€“ How do nodes behave across the globe?</li>

  </ul>


      </article>



      <article class="">

        <h3>Novice â€“ How healthy is a system and at what cost?</h3>
        <img src="./2019-devcon/dashboard_multi.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 17em; bottom: 0.75em; font-size: 20px;">Every metric tells a story... but we need to go deeper</span>


      </article>



      <article class="">

        <h3>Intermediate â€“ What is the system doing with its resources? (Net)</h3>
        <img src="./2019-devcon/dashboard_network.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 15.5em; bottom: 2em; font-size: 20px;">Transaction propagation at 1.1MB/s â‡’ New propagation algo</span>
<span style="position: absolute; right: 13.05em; bottom: 0.5em; font-size: 20px;">Synchronization data serving at 1.3MB/s â‡’ New seed node mechanism</span>


      </article>



      <article class="">

        <h3>Intermediate â€“ What is the system doing with its resources? (CPU)</h3>
        <img src="./2019-devcon/dashboard_cpu.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    CPU load comes up in curious places
  </p>


  <ul>

    <li>Block processing is a whole can of worms</li>

    <li>Transaction validation and propagation is surprising</li>

    <li>RPC calls are unpredictable, network handshake unexpected</li>

  </ul>


      </article>



      <article class="">

        <h3>Intermediate â€“ What is the system doing with its resources? (Disk)</h3>
        <img src="./2019-devcon/dashboard_disk.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 22em; top: 11.75em; font-size: 20px;">This doesn't look like much...</span>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Accurate disk I/O measurement is notoriously hard
  </p>


  <ul>

    <li>Executed I/O depends on RAM and fsync â‡’ can't measure the hw</li>

    <li>Virtualization and containers mess counters â‡’ can't measure the host</li>

    <li>Libraries cover up hidden and background costs â‡’ can't measure the node</li>

  </ul>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    <i>We added our disk monitoring *into* LevelDB itself! Can't split by data type though.</i>
  </p>



      </article>



      <article class="">

        <h3>Advanced â€“ Why is the system doing something in particular?</h3>
        <img src="./2019-devcon/dashboard_les.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 39em; bottom: 4.25em; font-size: 12px;">Maybe ~1/3rd of the light server charts...</span>
<span style="position: absolute; left: 1.5em; bottom: 1em; font-size: 20px;">Sisyphean task: Measure the tiniest of intricacies of the current algorithms... which might become stale with th first update...</span>


      </article>



      <article class="">

        <h3>All Star â€“ How does a change influence the system? (Seek PR â€“ Good)</h3>
        <img src="./2019-devcon/dashboard_seek.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 15.5em; bottom: 0.1em; font-size: 20px;">Green was master, yellow was the proposed change</span>


      </article>



      <article class="">

        <h3>All Star â€“ How does a change influence the system? (File size PR â€“ Bad)</h3>
        <img src="./2019-devcon/dashboard_resize.png" style="position: absolute; right: 1em; top: 3.5em; width: 1044px; border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 17em; bottom: 1.2em; font-size: 20px;">Blue was master, purple was the proposed change</span>
<span style="position: absolute; right: 32em; bottom: 0em; font-size: 12px;">* Dashboard is messy as it was flattened into a single screen for PR posterity</span>


      </article>



      <article class="">

        <h3>All Star â€“ How does a change influence the system? (Trie â€“ Tradeoff)</h3>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Most performance decisions are hard
  </p>


  <ul>

    <li>Benefits are generally not spectacular</li>

    <li>Improvements in an area degrade others</li>

  </ul>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    <i>Sometimes degrading certain things is necessary</i> ðŸ˜ž
  </p>

<img src="./2019-devcon/dashboard_cache_closeup.png" style="position: absolute; right: 1em; top: 5.5em; width: 500px;">
<span style="position: absolute; right: 16em; top: 27.5em; font-size: 12px;">Close-up of the Shanghai DoS attacks</span>

<img src="./2019-devcon/dashboard_cache.png" style="position: absolute; right: 1em; bottom: 3em; width: 1044px;">
<span style="position: absolute; right: 35em; bottom: 4.5em; font-size: 12px;">Zoomed out view of the same code across a full import</span>


      </article>



      <article class="">

        <h3>Monitoring infrastructure</h3>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Enterprise QoS or self-hosted OSS? Â¹
  </p>


  <ul>

    <li>Datadog â€“ Monitoring as a service</li>

    <li>Grafana â€“ On-premise monitoring</li>

  </ul>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Time series database for Grafana? Â¹
  </p>


  <ul>

    <li>Prometheus â€“ Pull model</li>

    <li>InfluxDB â€“ Push model</li>

  </ul>
<img src="./2019-devcon/datadog.svg" style="position: absolute; right: 13em; top: 5.5em; height: 150px;">
<img src="./2019-devcon/grafana.svg" style="position: absolute; right: 6em; top: 7.5em; height: 150px;">

<img src="./2019-devcon/prometheus.svg" style="position: absolute; right: 12em; bottom: 9em; height: 50px;">
<img src="./2019-devcon/influxdb.svg" style="position: absolute; right: 5em; bottom: 6em; height: 50px;">

<span style="position: absolute; left: 5em; bottom: 3.5em; font-size: 12px;">Â¹ Geth supports all combos! ExpVar and Prometheus scraping (<code>--metrics</code>) + InfluxDB pushing (<code>--metrics.influxdb</code>)</span>
<span style="position: absolute; left: 5em; bottom: 2em; font-size: 12px;">Â² Our own <em>current</em> Grafana &amp; InfluxDB dashboards:
  <a href="http://localhost:3999/metrics/grafana-influx-single.json" target="_blank">Single Geth</a> |
  <a href="http://localhost:3999/metrics/grafana-influx-multi.json" target="_blank">Multi Geth</a> |
  <a href="http://localhost:3999/metrics/grafana-influx-dual.json" target="_blank">Dual Geth</a>
</span>


      </article>



      <article class="">

        <h3>Lessons learned</h3>

<div class="image">
  <img src="./2019-devcon/whitespace.png">
</div>


  <p>
    Measure as low as you can
  </p>


  <ul>

    <li>Every abstraction transforms data and often adds out-of-band processing. Accurate numbers for all code paths need counting at the bottom. The hard part is correlating the measurements back to high level actions.</li>

  </ul>


  <p>
    Measure your worst-case numbers
  </p>


  <ul>

    <li>The OS is magical and optimizes your faults away (e.g. dedup disk i/o). However, it's not a silver bullet. If you reach its limit (e.g. memory full), it will blow up all at once!</li>

  </ul>


  <p>
    Measure everything that you can afford to
  </p>


  <ul>

    <li>Measurements are not free, rather a gradient between cheap and prohibitive. When issues arise however, you either have enough numbers, or you repeat the problem.</li>

  </ul>


      </article>



      <article class="">
        <h3>Thank you</h3>

          <div class="presenter">


  <p>
    PÃ©ter SzilÃ¡gyi
  </p>

<p class="link"><a href="mailto:peter@ethereum.org" target="_blank">peter@ethereum.org</a></p><p class="link"><a href="http://twitter.com/peter_szilagyi" target="_blank">@peter_szilagyi</a></p>
          </div>

          <div class="presenter">


  <p>
    Go Ethereum Lead
  </p>

<p class="link"><a href="https://ethereum.org/" target="_blank">https://ethereum.org/</a></p>
          </div>

        <img src="./2019-devcon/mesh.svg" width="600px" style="position: absolute; bottom: -12.5em; right: -5em">
        <img src="./2019-devcon/starqr.svg" width="250px" style="position: absolute; bottom: 3.5em; left: 8em; transform: rotate(-15deg);">
      </article>

    <div class="slide-area" id="prev-slide-area"></div><div class="slide-area" id="next-slide-area"></div></section>

    <div id="help">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76391520-1', 'auto');
      ga('send', 'pageview');
    </script>


<link rel="stylesheet" type="text/css" href="./2019-devcon/fonts.css"><link rel="stylesheet" type="text/css" href="./2019-devcon/styles.css"></body></html>
