<!DOCTYPE html>
<!-- saved from url=(0061)http://127.0.0.1:3999/2023-ethtokyo-original/blobpool.slide#1 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Transaction pooling in 4844</title>
    
    <script async="" src="./2023-ethtokyo/analytics.js"></script><script src="./2023-ethtokyo/slides.js"></script>
  <meta name="viewport" content="width=1100,height=750"><meta name="apple-mobile-web-app-capable" content="yes"></head>

  <body style="display: none" class="loaded">

    <section class="slides layout-widescreen">

      <article class="current">
        <h1 style="font-size: 48px;">Transaction pooling in 4844</h1>
        <h3 style="font-size: 36px; line-height: 36px;">How to not go boom, in theory</h3><br>
        <h3>15 April 2023</h3><h3>ETHTokyo</h3><br><br>
        <div class="presenter" style="position: absolute; bottom: 3em; left: 2em">
          
            
  
  <p>
    PÃ©ter SzilÃ¡gyi
  </p>
  

          
            
  
  <p>
    Go Ethereum Lead
  </p>
  

          
        </div>
        <img src="./2023-ethtokyo/logo.png" height="275px" style="position: absolute; bottom: 1em; right: 0.5em;">
      </article>

  
  
      <article class="next">
      
        <h2>What the heck is 4844?</h2>
      
      </article>
  
  
  
      <article class="far-next">
      
        <h3>Before 4844: Layer-2 chains on top of Ethereum</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Layer-2s are semi-independent blockchains
  </p>
  

  <ul>
  
    <li>Run transactions concurrently to Ethereum </li>
  
    <li>Collect results and create small commitments</li>
  
    <li>Submit the commitments to Ethereum as proofs</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Layer-2 chains <i>potentially</i> scale Ethereum
  </p>
  

  <ul>
  
    <li>Commitments are submitted periodically â‡’ lower per-transaction fees ðŸ™‚</li>
  
    <li>Commitments can be challenged a while â‡’ lower overall chain security ðŸ« </li>
  
    <li>Commitments are useless after that time â‡’ wasted mainnet chain space ðŸ¥´</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>After 4844: Layer-2 chains on top of Ethereum... cheaper</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Data lives forever on Ethereum â‡’ adding new data is expensive
  </p>
  

  <ul>
  
    <li>Transaction input data costs 16 gas per byte â‡’ 128KB data â‰ˆ 0.05 ETH @ 25 gwei</li>
  
    <li>Contract storage costs 20.000 gas per 32 â‡’ 128KB data â‰ˆ 2.05 ETH @ 25 gwei</li>
  
    <li>Receipt log data costs 8 gas per byte â‡’ 128KB data â‰ˆ 0.025 ETH @ 25 gwei </li>
  
  </ul>

  
  <p>
    Commitments <b>don't need to</b> live forever â‡’ archiving them is insanity
  </p>
  

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    <a href="https://eips.ethereum.org/EIPS/eip-4844" target="_blank">EIP-4844</a> introduces transactions with 128KB ephemeral data blobs
  </p>
  

  <ul>
  
    <li>Blobs are dropped after a monthÂ¹ â‡’ long term storage usage is zeroÂ²</li>
  
    <li>Separate pricing, similar to 1559 â‡’ DoS protected, may cost 1 wei / byteÂ³</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>EIP-4844: Preferential treatment of layer-2s...</h3>
        <img src="./2023-ethtokyo/treatment.jpg" style="position: absolute; right: 0em; top: 0.5em; width: 270px;">
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum users and layer-2 operators are separated
  </p>
  

  <ul>
  
    <li>Users pay the <code>basefee</code> for data â‡’ large txs are expensive</li>
  
    <li>Layer-2s pay the <code>datafee</code> for attached blobs â‡’ large txs are cheap</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Is is fair that layer-2s can transact cheaper?
  </p>
  

  <ul>
  
    <li>Blobs consume <b>data gas</b> â‡’ no competition for <b>execution gas</b></li>
  
    <li>Blobs pay in <b>data fee</b> â‡’ no upwards force on the <b>base fee</b></li>
  
  </ul>

  
  <p>
    EIP-4844 <b>enables</b> layer-2s while <b>reducing</b> costs for others
  </p>
  

      
      </article>
  
  
  
      <article class="">
      
        <h2>Blob-transaction pooling</h2>
      
      </article>
  
  
  
      <article class="">
      
        <h3>Transaction size</h3>
        <img src="./2023-ethtokyo/topology-mesh.png" style="position: absolute; right: 7em; top: 4em; width: 120px;">
<img src="./2023-ethtokyo/topology-star.png" style="position: absolute; right: 1.5em; top: 4em; width: 120px;">

<img src="./2023-ethtokyo/propagation.png" style="position: absolute; right: 1.5em; top: 8em; width: 260px;  border:solid 1px rgba(0,0,0,.3); -webkit-border-radius:8px; -moz-border-radius:8px; border-radius:8px;">
<span style="position: absolute; right: 3.5em; top: 23.5em; font-size: 14px;">propagations/sec on mainnet, 50 peers, 24h</span>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions are small (&lt;1 KB)
  </p>
  

  <ul>
  
    <li>Propagation is achieved via <i>broadcasting</i> to <code>sqrt</code> peers (red)</li>
  
    <li><i>Announced</i> to other peers for degenerate networks (green)</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Blob transactions are 128KB+ (potentially up to 512KB or 2MB)
  </p>
  

  <ul>
  
    <li>Peers must only receive them once â‡’ no broadcasts, request on demand</li>
  
    <li>Concurrent fetches must not overload â‡’ announce tx type and size too (<code>eth/68</code>)</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>Block space</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum blocks fit many transactions (up to 1428 @ 30M gas)
  </p>
  

  <ul>
  
    <li>Churn rate of the transaction pool is high â‡’ disk persistence is problematic</li>
  
    <li>Limited transaction pool capacity (RAM) â‡’ resend issues and eviction attacks</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Data blobs per block are aggressively capped (4 or 16)
  </p>
  

  <ul>
  
    <li>Persistency latency becomes acceptable (8 writes in 12 sec)</li>
  
    <li>Capacity can be increased significantly (80K txs @ 10GB)</li>
  
    <li>Evicting legit transactions becomes unreasonable*</li>
  
  </ul>

  
  <p>
    <b>Artificial churn (i.e. pool wars) must be avoided</b>
  </p>
  

      
      </article>
  
  
  
      <article class="">
      
        <h3>Purpose of transactions</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions are supposed to be generic
  </p>
  

  <ul>
  
    <li>Bad practice to restrict based on anticipated use cases</li>
  
    <li>Replacements and cancellations are expected to work</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Layer-2s are meant to use blobs to commit proofs
  </p>
  

  <ul>
  
    <li>Commitments are independent of Ethereum, cannot become stale</li>
  
    <li>No reason for cancellations, layer-2s need to commit regularly</li>
  
    <li>No reason for replacements, apart from fee adjustments</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>Cost of replacements</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions can be replaced (1 wei start, 10% fee bump)
  </p>
  

  <ul>
  
    <li>Transactions are small â‡’ propagating replacements is cheap</li>
  
    <li>Validations are quick â‡’ processing replacements is cheap</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Blob transactions are expensive to replace
  </p>
  

  <ul>
  
    <li>Re-propagating a blob transaction costs bandwidth (<code>N*128KB</code>)</li>
  
    <li>Re-validating a blob transaction costs processing time (<code>N*2ms</code>)</li>
  
  </ul>

  
  <p>
    <b>Replacements must be penalized (1 gwei start, 100% fee bump)</b>
  </p>
  

      
      </article>
  
  
  
      <article class="">
      
        <h3>Cost of cancellations</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transaction can be cancelled
  </p>
  

  <ul>
  
    <li>A contract call can be cancelled via a self transfer</li>
  
    <li>Subsequent transactions can be cancelled via account sweeps</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Cancelling a blob transaction is a DoS vector
  </p>
  

  <ul>
  
    <li>Replacements mustn't invalidate propagated future ones</li>
  
    <li>Nonce gaps in blob transaction sequences are disallowed</li>
  
    <li>Pooled blob transactions exclude pooled non-blob ones</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>Relevancy of locality</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions can be tracked as local
  </p>
  

  <ul>
  
    <li>Pre-1559, locals permitted 0 gas price for miners ðŸ™ƒ</li>
  
    <li>Locals are exempt from evictions due to out-pricing ðŸ˜Š</li>
  
    <li>Locality introduces a new dimension into pooling algos ðŸ« </li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Locality is less relevant for blob transactions
  </p>
  

  <ul>
  
    <li>1559's <i>basefee</i> and 4844's <i>datafee</i> remove fee games</li>
  
    <li>Large disk persistency reduces reason for eviction protection*</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>Genericity of transactions</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions are always supersets*
  </p>
  

  <ul>
  
    <li>Access list transactions extend Homestead ones</li>
  
    <li>1559 dynamic fee transactions extend access list ones</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Blob transactions should be standalone
  </p>
  

  <ul>
  
    <li>Blobless blob transactions are 1559 transactions</li>
  
    <li>0-blob transactions break low-churn, size uniformity, predictability </li>
  
    <li>Rejecting them in the pool but accepting in-protocol (blocks) breaks during reorgs</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>Lifecycle of transactions</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions get stored fully on the chain
  </p>
  

  <ul>
  
    <li>Upon inclusion, a transaction is dropped form the pool</li>
  
    <li>Upon reorg, a lost transaction is resurrected back into the pool</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Blob-transaction blobs are discarded from the chain
  </p>
  

  <ul>
  
    <li>Mini reorgs cannot resurrect transactions into the pool</li>
  
    <li>Blobs need to be stored until they are finalized and discardable</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h3>Points of entry</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Ethereum transactions are fully bundled in a block
  </p>
  

  <ul>
  
    <li>Downloaded blocks via sync contain even hidden MEV txs</li>
  
    <li>Propagated blocks via beacon payloads contain even hidden MEV txs</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Blob transactions are not fully bundled in a block
  </p>
  

  <ul>
  
    <li>Reorg of synced blocks will be unable to resurrect blobs</li>
  
    <li>Beacon clients must provide the blobs in the new payload API calls</li>
  
  </ul>

      
      </article>
  
  
  
      <article class="">
      
        <h2>Why all the constraints?</h2>
      
      </article>
  
  
  
      <article class="">
      
        <h3>Geth's prototype benchmarks</h3>
        
<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Legacy pool is capped at 4K transactions (@ 200MB RAM, no disk usage)
  </p>
  

  <ul>
  
    <li>Blob pool could be capped at 80K transactions (@ 20MB RAM, 10GB disk) ðŸ˜Š</li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    Legacy pool's post-block processing is ~1ms (@ 4K txs, 1D fees)
  </p>
  

  <ul>
  
    <li>Blob pool's post-block processing in ~75ms (@ 40K txs, 2D fees) ðŸ« </li>
  
  </ul>

<div class="image">
  <img src="./2023-ethtokyo/whitespace.png">
</div>

  
  <p>
    <i>Everything's a tradeoff. Constraints are good. Metrics are king.</i>
  </p>
  

      
      </article>
  
  

      <article class="">
        <h3>Thank you</h3>
        
          <div class="presenter">
            
  
  <p>
    PÃ©ter SzilÃ¡gyi
  </p>
  
<p class="link"><a href="mailto:peter@ethereum.org" target="_blank">peter@ethereum.org</a></p><p class="link"><a href="http://twitter.com/peter_szilagyi" target="_blank">@peter_szilagyi</a></p>
          </div>
        
          <div class="presenter">
            
  
  <p>
    Go Ethereum Lead
  </p>
  
<p class="link"><a href="https://ethereum.org/" target="_blank">https://ethereum.org/</a></p>
          </div>
        
        <img src="./2023-ethtokyo/mesh.svg" width="600px" style="position: absolute; bottom: -12.5em; right: -5em">
      </article>

    <div class="slide-area" id="prev-slide-area"></div><div class="slide-area" id="next-slide-area"></div></section>

    <div id="help" style="display: none;">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
    </div>

    
    <script src="./2023-ethtokyo/play.js"></script>
    

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76391520-1', 'auto');
      ga('send', 'pageview');
    </script>
  

<link rel="stylesheet" type="text/css" href="./2023-ethtokyo/fonts.css"><link rel="stylesheet" type="text/css" href="./2023-ethtokyo/styles.css"></body></html>